<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editar Personaje</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
    <div class="container">
        <h2>Editar Personaje: {{ personaje.nombre }} {{ personaje.apellido }}</h2>
        <form id="editarForm">
            <div class="mb-3">
                <label>Nombre</label>
                <input type="text" name="nombre" class="form-control" value="{{ personaje.nombre }}">
            </div>
            <div class="mb-3">
                <label>Apellido</label>
                <input type="text" name="apellido" class="form-control" value="{{ personaje.apellido }}">
            </div>
            <div class="mb-3">
                <label>Edad</label>
                <input type="number" name="edad" class="form-control" value="{{ personaje.edad }}">
            </div>
            <div class="mb-3">
                <label>Género</label>
                <input type="text" name="genero" class="form-control" value="{{ personaje.genero }}">
            </div>
            <div class="mb-3">
                <label>Ocupación</label>
                <input type="text" name="ocupacion" class="form-control" value="{{ personaje.ocupacion }}">
            </div>
            <div class="mb-3">
                <label>Etnia</label>
                <input type="text" name="etnia" class="form-control" value="{{ personaje.etnia }}">
            </div>
            <div class="mb-3">
                <label>Descripción</label>
                <textarea name="descripcion" class="form-control">{{ personaje.descripcion }}</textarea>
            </div>
            <div class="mb-3">
                <label>Historia</label>
                <textarea name="historia" class="form-control">{{ personaje.historia }}</textarea>
            </div>
            <div class="mb-3">
                <label>Inventario (JSON)</label>
                <textarea name="inventario" class="form-control">{{ personaje.inventario }}</textarea>
            </div>
            <div class="mb-3">
                <label>Notas</label>
                <textarea name="notas" class="form-control">{{ personaje.notas }}</textarea>
            </div>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            <a href="{{ url_for('personajes_bp.listar_personajes') }}" class="btn btn-secondary">Cancelar</a>
        </form>
    </div>

    <script>
    const form = document.getElementById("editarForm");
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = {{ personaje.idpersonaje }};
        const token = localStorage.getItem("jwt_token"); // o como guardes el JWT

        const payload = {
            nombre: form.nombre.value,
            apellido: form.apellido.value,
            edad: parseInt(form.edad.value),
            genero: form.genero.value,
            ocupacion: form.ocupacion.value,
            etnia: form.etnia.value,
            descripcion: form.descripcion.value,
            historia: form.historia.value,
            notas: form.notas.value,
            inventario: JSON.parse(form.inventario.value || "[]")
        };

        try {
            const res = await fetch(`/personajes/${id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (res.ok) {
                alert("Personaje actualizado correctamente");
                window.location.href = "/personajes";
            } else {
                alert("Error al actualizar: " + data.error || JSON.stringify(data));
            }
        } catch (err) {
            alert("Error de red: " + err);
        }
    });
    </script>
</body>
</html>
